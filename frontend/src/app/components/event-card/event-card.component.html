<!-- Preview Mode -->
<div
  class="card p-0 my-2 border-0"
  style="border-radius: 12px; cursor: pointer;"
  *ngIf="!isDetailMode"
>
  <img [src]="event.imageUrl" class="event-image" alt="Event image" style="border-radius: 12px 12px 0px 0px;"/>

  <div class="card-body bg-secondary" style="border-radius: 0px 0px 12px 12px;">
    <h5 class="card-title">
      {{ event.title }}
      <i *ngIf="event.booked" class="fas fa-download ms-2" style="cursor: pointer; font-size: 1rem;" (click)="onDownloadPdf()"></i>
    </h5>
    <p class="card-text m-0">
      <i class="fas fa-map-marker-alt me-1"></i>
      <a
        [href]="'https://www.google.com/maps/search/?api=1&query=' + event.location.latitude + ',' + event.location.longitude"
        target="_blank"
        rel="noopener noreferrer"
        class="text-reset text-decoration-none"
      >
        {{ event.location.name }}
      </a>
      <i class="fas fa-calendar-alt ms-3 me-1"></i> {{ event.date | date:'dd.MM.yyyy' }}
    </p>

    <button class="btn btn-primary w-100 mt-2" (click)="toggleDetailMode()">
      Details
    </button>
  </div>
</div>

<!-- Detail Mode (Fullscreen Overlay) -->
<!-- Detail Mode (Fullscreen Overlay) -->
<div
  class="position-fixed top-0 start-0 w-100 h-100 bg-white overflow-auto"
  style="z-index: 1050;"
  *ngIf="isDetailMode"
>
  <!-- Close button -->
  <p
    class="position-absolute top-0 end-0 m-3 text-white"
    (click)="toggleDetailMode()"
    style="
      font-size: 1.5rem;
      cursor: pointer;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 4px 8px;
    "
    aria-label="Close"
  >
    <i class="fas fa-xmark"></i>
  </p>

  <img [src]="event.imageUrl" class="img-fluid" alt="Event image" />

  <div class="container p-4">
    <h4>
      {{ event.title }}<ng-container *ngIf="event.tickets?.length > 0">
        
        <!-- make the parent position-relative -->
        <div class="position-relative d-inline-block">
          <i
          class="fas fa-download ms-3"
          style="cursor: pointer; font-size: 1.25rem;"
          (click)="onDownloadPdf()"
          ></i>

          <!-- the badge -->
          <span
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary"
            style="font-size: 0.75rem;"
          >
            {{ event.tickets.length }}
            <span class="visually-hidden">Anzahl der Tickets</span>
          </span>
        </div>
      </ng-container>
    </h4>
    
      <!-- download all tickets + count -->
      

    <p class="mb-1">
      <i class="fas fa-calendar-alt me-1"></i>
      {{ event.date | date: 'dd.MM.yyyy' }}
      <i class="fas fa-map-marker-alt ms-2 me-1"></i>
      <a
        [href]="'https://www.google.com/maps/search/?api=1&query=' + event.location.latitude + ',' + event.location.longitude"
        target="_blank"
        rel="noopener noreferrer"
        class="text-reset text-decoration-none"
      >
        {{ event.location.name }}
      </a>
      <i class="fas fa-clock ms-2 me-1"></i>
      {{ event.date | date: 'HH:mm' }}
    </p>

    <p>{{ event.description }}</p>

    <p class="m-0">
      <strong>
        <i class="fas fa-user me-1"></i> {{ event.contact }}
      </strong>
    </p>

    <div>
      <small class="text-muted">Preis pro Ticket</small>
      <div class="fw-bold">{{ formattedPrice }}</div>
    </div>

    <div class="mt-2 position-relative">
  <!-- BOOK TICKETS BUTTON -->
  <button
    class="btn btn-primary w-100"
    (click)="toggleBooking()"
  >
    {{ event.booked ? 'Weitere Tickets buchen' : 'Eventtickets buchen' }}
  </button>

  <!-- SLIDING-UP BOOKING PANEL -->
  <div
    *ngIf="bookingMode"
    class="mt-3 p-3 bg-light border rounded shadow-sm slide-up position-relative"
  >
    <div
  *ngIf="bookingMode"
  class="mt-3 p-3 bg-light border rounded shadow-sm slide-up position-relative"
>
  <!-- × Close -->
  <button
    type="button"
    class="btn-close position-absolute top-0 end-0 m-2"
    aria-label="Close"
    (click)="toggleBooking()"
  ></button>

  <!-- PRICE & TOTAL DISPLAY -->
  <div class="d-flex justify-content-between mb-3">
    <div>
      <small class="text-muted">Preis pro Ticket</small>
      <div class="fw-bold">{{ formattedPrice }}</div>
    </div>
    <div>
      <small class="text-muted">Gesamt</small>
      <div class="fw-bold">{{ formattedTotal }}</div>
    </div>
  </div>

  <!-- PLUS / MINUS COUNTER -->
  <div class="d-flex align-items-center justify-content-center my-3">
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="decrement()"
      [disabled]="ticketCount <= 1"
    >
      −
    </button>

    <span class="mx-4 fs-5">{{ ticketCount }}</span>

    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="increment()"
      [disabled]="ticketCount >= maxTickets"
    >
      +
    </button>
  </div>

  <!-- PROCEED BUTTON -->
  <!-- STEP 1: Show “Weiter zu Stripe” if we haven’t mounted CardElement yet -->
<div *ngIf="!paymentMode">
  <button
    class="btn btn-success w-100"
    (click)="initPayment()"
  >
    Weiter zu Stripe
  </button>
</div>

<!-- STEP 2: Once clientSecret & CardElement are ready, show card form -->
<div *ngIf="paymentMode" class="mt-3">
  <div #cardInfo id="card-element" class="mb-2"></div>
  <div *ngIf="paymentError" class="text-danger mb-2">{{ paymentError }}</div>
  <button
    class="btn btn-primary w-100"
    (click)="confirmPayment()"
  >
    Zahlung abschließen
  </button>
</div>
</div>
</div>
  </div>
</div>
