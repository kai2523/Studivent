#!/bin/bash
set -euo pipefail

echo "ğŸš€ Starte install_dependencies Skript..."
echo "ğŸ“‚ Aktuelles Verzeichnis (vor mkdir): $(pwd)"

# 1) Erstelle /var/www/html mit root-Rechten und gib ubuntu den Besitz
sudo mkdir -p /var/www/html
sudo chown ubuntu:ubuntu /var/www/html
echo "ğŸ“ Verzeichnis /var/www/html erstellt und Besitz auf ubuntu gesetzt."

# 2) Wechsel in den Web-Root (dort wird spÃ¤ter deployt)
cd /var/www/html || {
  echo "âŒ Fehler: /var/www/html existiert nicht oder konnte nicht betreten werden."
  exit 1
}
echo "ğŸ“‚ Neues Arbeitsverzeichnis: $(pwd)"

# 3) Node.js (inkl. npm) installieren, falls noch nicht vorhanden
if ! command -v npm &> /dev/null; then
  echo "ğŸ“¦ Node.js wird installiert..."
  curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
  sudo apt-get update -y
  sudo apt-get install -y nodejs
else
  echo "âœ… Node.js ist bereits installiert. Version: $(node -v) / npm $(npm -v)"
fi

# 4) AbhÃ¤ngigkeiten installieren (falls package.json da ist)
echo "ğŸ“„ Dateien im aktuellen Verzeichnis:"
ls -la

if [ -f "package.json" ]; then
  echo "ğŸ“¦ package.json gefunden â€“ fÃ¼hre 'npm install' aus..."
  sudo npm install
  echo "âœ… npm install erfolgreich abgeschlossen."
else
  echo "âš ï¸ Keine package.json gefunden â€“ npm install Ã¼bersprungen."
fi

echo "âœ… install_dependencies vollstÃ¤ndig durchgelaufen."
