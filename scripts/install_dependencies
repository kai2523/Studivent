#!/bin/bash
set -euo pipefail

echo "ğŸš€ Starte install_dependencies Skript..."
echo "ğŸ“‚ Aktuelles Verzeichnis (vor mkdir): $(pwd)"

# 1) Erstelle /var/www/html mit root-Rechten und gib ubuntu den Besitz
sudo mkdir -p /var/www/html
sudo chown ubuntu:ubuntu /var/www/html
echo "ğŸ“ Verzeichnis /var/www/html erstellt und Besitz auf ubuntu gesetzt."

# 2) Wechsel in den Web-Root
cd /var/www/html
echo "ğŸ“‚ Neues Arbeitsverzeichnis: $(pwd)"

# 3) Stelle Node.js >=20 sicher
NODE_MAJOR=$(node -v 2>/dev/null | cut -d. -f1 | tr -d 'v' || echo 0)
if [ "$NODE_MAJOR" -lt 20 ]; then
  echo "ğŸ“¦ Node.js-Version $NODE_MAJOR erkannt (<20). Installiere Node.js 20.x..."
  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
  sudo apt-get install -y nodejs
else
  echo "âœ… Node.js ist bereits >=20: $(node -v)"
fi

# 4) Stelle Yarn sicher
if ! command -v yarn &> /dev/null; then
  echo "ğŸ“¦ Yarn nicht gefunden. Installiere global..."
  sudo npm install -g yarn
else
  echo "âœ… Yarn ist bereits installiert: $(yarn -v)"
fi

# 5) In den Backend-Ordner wechseln und Dependencies installieren
cd backend
echo "ğŸ“‚ Arbeitsverzeichnis: $(pwd)"
echo "ğŸ“¦ Installiere Production-Dependencies via Yarn..."
sudo yarn install --production --silent

echo "ğŸ”¨ FÃ¼hre Build aus..."
sudo yarn build

# 6) Logs-Verzeichnis fÃ¼r PM2 anlegen
mkdir -p logs
echo "ğŸ“ logs/-Ordner erstellt (fÃ¼r PM2)."

echo "âœ… install_dependencies abgeschlossen!"
