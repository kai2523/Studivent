#!/bin/bash
set -euo pipefail

echo "Starte install_dependencies Skript..."
echo "Aktuelles Verzeichnis: $(pwd)"

# 1) Web-Root anlegen
sudo mkdir -p /var/www/html
sudo chown ubuntu:ubuntu /var/www/html
cd /var/www/html

# 2) Node.js ≥20 installieren (non-interactive)
export DEBIAN_FRONTEND=noninteractive
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get update
sudo apt-get install -y nodejs

# 3) Yarn sicherstellen
if ! command -v yarn &> /dev/null; then
  sudo npm install -g yarn
fi

# 4) In Backend, alle Deps holen, bauen, dann nur Production-Deps beibehalten
cd backend
yarn install --silent
yarn build
yarn install --production --silent

# 5) Logs-Ordner für PM2
mkdir -p logs

echo "install_dependencies abgeschlossen!"
