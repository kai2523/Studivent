#!/bin/bash
set -euo pipefail

echo "Starte install_dependencies Skript..."
echo "Aktuelles Verzeichnis: $(pwd)"

# 1) Web-Root anlegen und Besitzrechte setzen (rekursiv)
sudo mkdir -p /var/www/html
sudo chown -R ubuntu:ubuntu /var/www/html
cd /var/www/html

# Optional: Alte Dateien entfernen, falls noch Reste von vorherigen Deployments da sind
# sudo rm -rf /var/www/html/*

# 2) Node.js ≥20 installieren (non-interactive)
export DEBIAN_FRONTEND=noninteractive
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get update
sudo apt-get install -y nodejs

# 3) Yarn installieren (deb-basiert statt npm -g, vermeidet root-Cache-Probleme)
if ! command -v yarn &> /dev/null; then
  curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
  echo "deb https://dl.yarnpkg.com/debian stable main" \
    | sudo tee /etc/apt/sources.list.d/yarn.list
  sudo apt-get update
  sudo apt-get install -y yarn
fi

# ────────────── BACKEND ─────────────────────────

cd /var/www/html/backend

# Alte node_modules wegräumen
rm -rf node_modules

# Besitzrechte sicherstellen
sudo chown -R ubuntu:ubuntu .

# Dev-Dependencies installieren, bauen und Production-only installieren
yarn install --silent
yarn build
yarn install --production --silent

# Logs-Ordner für PM2
mkdir -p logs

echo "Backend-Abhängigkeiten installiert und gebaut."

# ────────────── FRONTEND ────────────────────────

cd /var/www/html/frontend

# Alte node_modules wegräumen
rm -rf node_modules

# Sicherstellen, dass ubuntu alle Dateien schreiben darf
sudo chown -R ubuntu:ubuntu .

# 1) Dependencies installieren
npm ci --silent

# 2) Angular für Production bauen
# Achtung: Ersetze `studivent` mit deinem tatsächlichen Projekt-Namen!
ng build --configuration production

# 3) Ausgabe in den Web-Root kopieren
# Entferne ggf. altes Frontend
rm -rf /var/www/html/dist
cp -R dist/studivent /var/www/html/dist

# Besitzrechte im Ziel korrigieren
sudo chown -R ubuntu:ubuntu /var/www/html/dist

echo "Frontend-Abhängigkeiten installiert, gebaut und ausgeliefert."

echo "install_dependencies abgeschlossen!"
