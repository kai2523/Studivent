#!/bin/bash
set -euo pipefail

echo "🚀 Starte install_dependencies Skript..."
echo "📂 Aktuelles Verzeichnis (vor mkdir): $(pwd)"

# 1) Erstelle /var/www/html mit root-Rechten und gib ubuntu den Besitz
sudo mkdir -p /var/www/html
sudo chown ubuntu:ubuntu /var/www/html
echo "📁 Verzeichnis /var/www/html erstellt und Besitz auf ubuntu gesetzt."

# 2) Wechsel in den Web-Root (dort wird später deployt)
cd /var/www/html || {
  echo "❌ Fehler: /var/www/html existiert nicht oder konnte nicht betreten werden."
  exit 1
}
echo "📂 Neues Arbeitsverzeichnis: $(pwd)"

if ! command -v yarn &> /dev/null; then
  echo "📦 Yarn nicht gefunden. Installiere global..."
  npm install -g yarn
else
  echo "✅ Yarn ist bereits installiert: $(yarn -v)"
fi

cd backend
echo "📂 Wechsle in backend/: $(pwd)"

echo "📦 Installiere Production-Dependencies via Yarn..."
yarn install --production --silent

echo "🔨 Führe Build aus..."
yarn build

mkdir -p logs
echo "📁 logs/-Ordner erstellt (für PM2)."

echo "✅ install_dependencies abgeschlossen!"
