#!/bin/bash

echo "ğŸš€ Starte start_server Skript..."
cd /var/www/html || {
  echo "âŒ /var/www/html nicht gefunden"
  exit 1
}

echo "ğŸ“‚ Aktuelles Verzeichnis: $(pwd)"
echo "ğŸ“„ Dateien:"
ls -la

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BACKEND mit PM2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BACKEND_APP="backend-api"

if pm2 list | grep -q "$BACKEND_APP"; then
  echo "ğŸ” Reload bestehender PM2-Prozess ($BACKEND_APP)..."
  pm2 reload ecosystem.config.js --only "$BACKEND_APP"
else
  echo "ğŸš€ Starte neue PM2-App ($BACKEND_APP) mit ecosystem.config.js..."
  pm2 start ecosystem.config.js
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FRONTEND als Static-Server â”€â”€â”€â”€â”€

FRONTEND_APP="frontend-static"

# pm2 serve liefert ein Verzeichnis Ã¼ber HTTP (Default Port 8080)
if pm2 list | grep -q "$FRONTEND_APP"; then
  echo "ğŸ” Reload bestehender PM2-Static-Server ($FRONTEND_APP)..."
  pm2 reload "$FRONTEND_APP"
else
  echo "ğŸš€ Starte neuen PM2-Static-Server fÃ¼r /var/www/html/dist..."
  pm2 serve /var/www/html/dist 80 --name "$FRONTEND_APP" --spa
fi

# Prozesse nach Reboot wiederherstellen
pm2 save

echo "âœ… PM2-Prozesse laufen (Backend: $BACKEND_APP, Frontend: $FRONTEND_APP)."
